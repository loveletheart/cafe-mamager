<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>QR 로그인</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.3.2/jsQR.min.js"></script>
</head>
<body>
    <h1>QR 로그인</h1>

    <h3>아래 QR 코드 중 하나를 스캔하여 로그인하세요.</h3>
    <div th:each="id : ${ids}">
        <img th:src="@{'/qr_codes/qr_' + ${id} + '.png'}" width="200" height="200"/>
        <p>ID: <span th:text="${id}"></span></p>
    </div>

    <h2>QR 코드 스캔</h2>
    <video id="camera" autoplay style="width: 300px; height: 300px;"></video>
    <canvas id="qrCanvas" hidden></canvas>
    <p id="qrResult"></p>

    <script>
        const video = document.getElementById("camera");
        const canvas = document.getElementById("qrCanvas");
        const context = canvas.getContext("2d");
        const resultText = document.getElementById("qrResult");

        // 카메라 활성화
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
            .then(stream => {
                video.srcObject = stream;
                scanQRCode();
            })
            .catch(err => console.error("카메라 접근 불가: ", err));

        function scanQRCode() {
            setInterval(() => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                let imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                let code = jsQR(imageData.data, imageData.width, imageData.height);
                
                if (code) {
                    resultText.innerText = "QR 코드 인식됨: " + code.data;
                    window.location.href = "/login/qr?qrCode=" + encodeURIComponent(code.data);
                }
            }, 1000);
        }
    </script>
</body>
</html>